generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum UserRole {
  USER
  ADMIN
}
enum PlayerPosition {
  Goalkeeper
  Defender
  Midfielder
  Forward
}

enum MatchEventType {
  Goal
  YellowCard
  RedCard
  Substitution
}

enum MatchStatus {
  Scheduled
  Live
  Finished
  Canceled
  Postponed
  Suspended
}

enum CompetitionType {
  DomesticLeague
  DomesticCup
  InternationalClub
  InternationalNational
}

enum TransferType {
  Permanent
  Loan
  FreeAgent
  EndOfLoan
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubmissionTargetType {
  TEAM
  PLAYER
  LEAGUE
  MATCH
  MATCH_EVENT
  PLAYER_MATCH_STATS
  PLAYER_SEASON_STATS
  TRANSFER
  TROPHY
  PLAYER_TROPHY
  ODD
}

// MODELS

model User {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  email        String   @unique
  username     String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(USER)
  refreshTokenHash String?

  submissionsCreated Submission[] @relation("UserSubmissions")
  reviews            Review[]     @relation("UserReviews")
}

model Team {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String   @unique
  country     String
  stadium     String?
  logoUrl     String?
  founded     Int?

  players         Player[]
  homeMatches     Match[]            @relation("HomeTeamMatches")
  awayMatches     Match[]            @relation("AwayTeamMatches")
  leagues         League[]           @relation("LeagueTeams")
  transfersFrom   Transfer[]         @relation("TransfersFrom")
  transfersTo     Transfer[]         @relation("TransfersTo")
  seasonStats     PlayerSeasonStats[]
  teamSeasons     TeamSeason[]
  standings       Standing[]
}

model Player {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  name          String
  dateOfBirth   DateTime?
  nationality   String
  position      PlayerPosition
  jerseyNumber  Int?
  imageUrl      String?

  teamId        Int
  team          Team     @relation(fields: [teamId], references: [id])

  matchStats    PlayerMatchStats[]
  seasonStats   PlayerSeasonStats[]
  transfers     Transfer[]         @relation("PlayerTransfers")
  trophies      PlayerTrophy[]

  matchEvents   MatchEvent[] @relation("PrimaryPlayerEvents")
  assists       MatchEvent[] @relation("AssistingPlayerEvents")
  subbedIn      MatchEvent[] @relation("SubstitutionIn")
  subbedOut     MatchEvent[] @relation("SubstitutionOut")
}

model League {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  country   String
  logoUrl   String?
  competitionType CompetitionType @default(DomesticLeague)

  matches     Match[]
  teams       Team[]              @relation("LeagueTeams")
  seasonStats PlayerSeasonStats[]
  leagueSeasons LeagueSeason[]
  standings   Standing[]
}

model Match {
  id        Int         @id @default(autoincrement())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  matchDate DateTime
  stadium   String?
  round     String?     // e.g., "Group Stage", "Quarter-final"
  status    MatchStatus @default(Scheduled)
  isCup     Boolean     @default(false)

  homeTeamId  Int
  awayTeamId  Int
  homeScore   Int         @default(0)
  awayScore   Int         @default(0)
  homeTeam    Team        @relation("HomeTeamMatches", fields: [homeTeamId], references: [id])
  awayTeam    Team        @relation("AwayTeamMatches", fields: [awayTeamId], references: [id])

  leagueId    Int
  league      League      @relation(fields: [leagueId], references: [id])

  seasonId    Int?
  season      Season?     @relation(fields: [seasonId], references: [id])

  events      MatchEvent[]
  playerStats PlayerMatchStats[]
  odds        Odd[]

  @@index([leagueId, seasonId, status])
  @@index([matchDate])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@unique([leagueId, seasonId, matchDate, homeTeamId, awayTeamId])
}

model MatchEvent {
  id        Int            @id @default(autoincrement())
  minute    Int
  type      MatchEventType

  matchId   Int
  match     Match          @relation(fields: [matchId], references: [id])

  playerId  Int
  player    Player         @relation("PrimaryPlayerEvents", fields: [playerId], references: [id])

  assistingPlayerId Int?
  assistingPlayer   Player? @relation("AssistingPlayerEvents", fields: [assistingPlayerId], references: [id])

  playerInId  Int?
  playerOutId Int?
  playerIn    Player?        @relation("SubstitutionIn", fields: [playerInId], references: [id])
  playerOut   Player?        @relation("SubstitutionOut", fields: [playerOutId], references: [id])

  @@index([matchId])
  @@index([playerId])
}

model PlayerMatchStats {
  id              Int    @id @default(autoincrement())
  minutesPlayed   Int    @default(0)
  goals           Int    @default(0)
  assists         Int    @default(0)
  shots           Int    @default(0)
  shotsOnTarget   Int    @default(0)
  passes          Int    @default(0)
  passAccuracy    Float?
  tackles         Int    @default(0)
  interceptions   Int    @default(0)
  dribbles        Int    @default(0)
  foulsCommitted  Int    @default(0)
  foulsSuffered   Int    @default(0)
  yellowCards     Int    @default(0)
  redCards        Int    @default(0)
  saves           Int?   @default(0)
  expectedGoals   Float? // xG
  expectedAssists Float? // xA
  keyPasses       Int?   @default(0)
  rating          Float?

  playerId Int
  matchId  Int
  player   Player @relation(fields: [playerId], references: [id])
  match    Match  @relation(fields: [matchId], references: [id])

  @@unique([playerId, matchId])
  @@index([playerId])
  @@index([matchId])
}

// --- NEW MODELS FOR AGGREGATE STATS AND TRANSFERS ---

model PlayerSeasonStats {
  id              Int    @id @default(autoincrement())
  season          String // e.g., "2023/2024" (legacy, consider replacing with seasonId)
  appearances     Int    @default(0)
  minutesPlayed   Int    @default(0)
  goals           Int    @default(0)
  assists         Int    @default(0)
  shots           Int    @default(0)
  shotsOnTarget   Int    @default(0)
  passes          Int    @default(0)
  passAccuracy    Float?
  tackles         Int    @default(0)
  interceptions   Int    @default(0)
  dribbles        Int    @default(0)
  foulsCommitted  Int    @default(0)
  foulsSuffered   Int    @default(0)
  yellowCards     Int    @default(0)
  redCards        Int    @default(0)
  saves           Int?   @default(0)
  expectedGoals   Float? // xG
  expectedAssists Float? // xA
  keyPasses       Int?   @default(0)

  playerId Int
  teamId   Int
  leagueId Int
  seasonId Int?
  player   Player @relation(fields: [playerId], references: [id])
  team     Team   @relation(fields: [teamId], references: [id])
  league   League @relation(fields: [leagueId], references: [id])
  seasonRel   Season? @relation(fields: [seasonId], references: [id])

  @@unique([playerId, teamId, leagueId, seasonId, season])
  @@index([playerId])
  @@index([teamId])
  @@index([leagueId])
  @@index([seasonId])
}

model Transfer {
  id           Int          @id @default(autoincrement())
  transferDate DateTime
  transferFee  Float? // Can be null for free transfers
  transferType TransferType @default(Permanent)

  playerId     Int
  fromTeamId   Int?
  toTeamId     Int

  player       Player @relation("PlayerTransfers", fields: [playerId], references: [id])
  fromTeam     Team?  @relation("TransfersFrom", fields: [fromTeamId], references: [id])
  toTeam       Team   @relation("TransfersTo", fields: [toTeamId], references: [id])

  @@index([playerId])
  @@index([fromTeamId])
  @@index([toTeamId])
}

model Trophy {
  id          Int      @id @default(autoincrement())
  name        String   @unique // e.g., "Ballon d'Or", "Premier League Winner"
  type        String   // "Individual" or "Team"
  year        Int

  playerAwards PlayerTrophy[]
}

model PlayerTrophy {
  id       Int @id @default(autoincrement())
  season   String // e.g., "2023/2024"

  playerId Int
  trophyId Int
  player   Player @relation(fields: [playerId], references: [id])
  trophy   Trophy @relation(fields: [trophyId], references: [id])

  @@unique([playerId, trophyId, season])
}

model Odd {
  id          Int    @id @default(autoincrement())
  provider    String
  homeWinOdds Float
  drawOdds    Float
  awayWinOdds Float

  matchId Int   @unique
  match   Match @relation(fields: [matchId], references: [id])
}

// Moderation models

model Submission {
  id          Int                 @id @default(autoincrement())
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  targetType  SubmissionTargetType
  targetId    Int?
  operation   String              // CREATE | UPDATE | DELETE
  changes     Json                // proposed changes
  status      ModerationStatus    @default(PENDING)

  createdById Int
  createdBy   User                @relation("UserSubmissions", fields: [createdById], references: [id])

  reviews     Review[]

  @@index([status])
  @@index([targetType, targetId])
}

model Review {
  id           Int              @id @default(autoincrement())
  createdAt    DateTime         @default(now())
  decision     ModerationStatus
  comment      String?

  reviewerId   Int
  reviewer     User             @relation("UserReviews", fields: [reviewerId], references: [id])

  submissionId Int
  submission   Submission       @relation(fields: [submissionId], references: [id])

  @@index([submissionId])
}

// New scheduling and table models

model Season {
  id          Int      @id @default(autoincrement())
  name        String   // e.g., "2023/2024"
  startDate   DateTime?
  endDate     DateTime?

  leagueSeasons LeagueSeason[]
  matches       Match[]
  standings     Standing[]
  playerSeasonStats PlayerSeasonStats[]

  @@unique([name])
}

model LeagueSeason {
  id        Int    @id @default(autoincrement())
  leagueId  Int
  seasonId  Int

  league    League @relation(fields: [leagueId], references: [id])
  season    Season @relation(fields: [seasonId], references: [id])

  teams     TeamSeason[]

  @@unique([leagueId, seasonId])
  @@index([leagueId])
  @@index([seasonId])
}

model TeamSeason {
  id             Int    @id @default(autoincrement())
  teamId         Int
  leagueSeasonId Int

  team           Team         @relation(fields: [teamId], references: [id])
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id])

  @@unique([teamId, leagueSeasonId])
  @@index([teamId])
  @@index([leagueSeasonId])
}

model Standing {
  id             Int    @id @default(autoincrement())
  leagueId       Int
  seasonId       Int
  teamId         Int

  played         Int    @default(0)
  won            Int    @default(0)
  drawn          Int    @default(0)
  lost           Int    @default(0)
  goalsFor       Int    @default(0)
  goalsAgainst   Int    @default(0)
  goalDifference Int    @default(0)
  points         Int    @default(0)

  league         League @relation(fields: [leagueId], references: [id])
  season         Season @relation(fields: [seasonId], references: [id])
  team           Team   @relation(fields: [teamId], references: [id])

  @@unique([leagueId, seasonId, teamId])
  @@index([leagueId, seasonId])
  @@index([points, goalDifference, goalsFor])
}